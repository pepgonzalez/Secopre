/*
 * SCRIPT MODULO DE CHAT
 */

/*alter a user para agregar bandera que indica si tiene acceso al chat*/
ALTER TABLE SECOPRE.USER ADD HAS_CHAT_ACTIVE BIT(1) DEFAULT 1;

/*alter a user para agregar avatar, si viene nulo, setea imagen de avatar por defecto*/
ALTER TABLE SECOPRE.USER ADD AVATAR VARCHAR(255);

/*tabla de conversaciones*/
CREATE TABLE SECOPRE.CHAT_CONVERSATION(
	CONVERSATION_ID BIGINT(20) NOT NULL,
	USER_ID BIGINT(20) NOT NULL,
	CREATION_DATE DATE,
	LAST_UPDATE DATE,
	ACTIVE BIT(1) DEFAULT 1
);

ALTER TABLE SECOPRE.CHAT_CONVERSATION ADD UNIQUE UDX_CHAT_CONV_USER (CONVERSATION_ID, USER_ID);

ALTER TABLE SECOPRE.CHAT_CONVERSATION
	ADD CONSTRAINT FK_CHAT_CONV_USER
 	FOREIGN KEY(USER_ID) REFERENCES SECOPRE.USER(ID);

 	
/*TABLA DE MENSAJES*/
CREATE TABLE SECOPRE.CHAT_MESSAGE(
	MESSAGE_ID BIGINT(20) NOT NULL PRIMARY KEY AUTO_INCREMENT,
	CONVERSATION_ID BIGINT(20) NOT NULL,
	USER_FROM BIGINT(20) NOT NULL,
	USER_TO BIGINT(20) NOT NULL,
	MESSAGE VARCHAR(1000) NOT NULL,
	ESTATUS INT(1) NOT NULL DEFAULT 0,
	CREATION_DATE DATETIME,
	LAST_UPDATE DATETIME,
	ACTIVE BIT(1) DEFAULT 1
);
 	
ALTER TABLE SECOPRE.CHAT_MESSAGE
	ADD CONSTRAINT FK_C_MSG_CONV
 	FOREIGN KEY(CONVERSATION_ID) REFERENCES SECOPRE.CHAT_CONVERSATION(CONVERSATION_ID);
 	
ALTER TABLE SECOPRE.CHAT_MESSAGE
	ADD CONSTRAINT FK_C_MSG_USR_FROM
 	FOREIGN KEY(USER_FROM) REFERENCES SECOPRE.USER(ID); 
 	
ALTER TABLE SECOPRE.CHAT_MESSAGE
	ADD CONSTRAINT FK_C_MSG_USR_TO
 	FOREIGN KEY(USER_TO) REFERENCES SECOPRE.USER(ID); 	
 	
/*TABLA DE RELACION DE USUARIO Y SOCKET ABIERTO PARA REALTIME*/
CREATE TABLE SECOPRE.REL_USER_CONNECTION(
  USER_ID BIGINT(20) NOT NULL,
  SOCKET_ID VARCHAR(255),
  CREATION_DATE DATE,
  LAST_UPDATE DATE,
  ACTIVE BIT(1) DEFAULT 1
);

ALTER TABLE SECOPRE.REL_USER_CONNECTION
	ADD CONSTRAINT FK_REL_UC_USR
 	FOREIGN KEY(USER_ID) REFERENCES SECOPRE.USER(ID); 	


/*catalogo de puesto de los usuarios*/
CREATE TABLE SECOPRE.EMPLOYMENT(
  EMPLOYMENT_ID BIGINT(20) NOT NULL PRIMARY KEY AUTO_INCREMENT,
  DESCRIPTION VARCHAR(255) NOT NULL,
  CREATION_DATE DATETIME,
  LAST_UPDATE DATETIME,
  ACTIVE BIT(1) DEFAULT 1
);

/*relacion de usuarios y empleados*/
CREATE TABLE SECOPRE.REL_USER_EMPLOYMENT(
	USER_ID BIGINT(20) NOT NULL,
	EMPLOYMENT_ID BIGINT(20) NOT NULL,
	CREATION_DATE DATETIME,
  	LAST_UPDATE DATETIME,
  	ACTIVE BIT(1) DEFAULT 1
);

ALTER TABLE SECOPRE.REL_USER_EMPLOYMENT
	ADD CONSTRAINT FK_UE_USR
 	FOREIGN KEY(USER_ID) REFERENCES SECOPRE.USER(ID); 
 	
ALTER TABLE SECOPRE.REL_USER_EMPLOYMENT
	ADD CONSTRAINT FK_UE_EMP
 	FOREIGN KEY(EMPLOYMENT_ID) REFERENCES SECOPRE.EMPLOYMENT(EMPLOYMENT_ID); 

/*sp para iniciar una conversacion*/

DELIMITER $$
CREATE PROCEDURE SECOPRE.START_CONVERSATION(
 IN user1 INT,
 IN user2 INT,
 OUT cId INT)
BEGIN
 SELECT (max(CC.CONVERSATION_ID) + 1) next_cId
 INTO cId
 FROM SECOPRE.CHAT_CONVERSATION CC;
 
 INSERT INTO SECOPRE.CHAT_CONVERSATION
 (CONVERSATION_ID, USER_ID, CREATION_DATE)
 VALUES
 (cId, user1, SYSDATE());
 
 INSERT INTO SECOPRE.CHAT_CONVERSATION
 (CONVERSATION_ID, USER_ID, CREATION_DATE)
 VALUES
 (cId, user2, SYSDATE());
 
END$$
DELIMITER ;

